# CI/CD Pipeline for CV Maker
# 
# Bu workflow her PR ve push'ta otomatik olarak Ã§alÄ±ÅŸÄ±r
# Kod kalitesini garanti eder ve hatalÄ± kodun main branch'e girmesini engeller

name: CI/CD Pipeline

# Workflow ne zaman Ã§alÄ±ÅŸacak?
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Environment variables (tÃ¼m job'lar iÃ§in)
env:
  NODE_VERSION: '20.x'

jobs:
  # ============================================
  # JOB 1: TEST
  # TÃ¼m testleri Ã§alÄ±ÅŸtÄ±r
  # ============================================
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
      # 1. Kod deposunu indir
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Node.js kur
      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. Dependencies yÃ¼kle
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # 4. Testleri Ã§alÄ±ÅŸtÄ±r
      - name: ğŸ§ª Run tests
        run: npm test

      # 5. Test coverage raporu oluÅŸtur (opsiyonel)
      - name: ğŸ“Š Generate coverage report
        run: npm test -- --coverage
        continue-on-error: true

  # ============================================
  # JOB 2: BUILD
  # Production build kontrolÃ¼
  # ============================================
  build:
    name: ğŸ—ï¸ Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # Next.js build (production)
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          # Build iÃ§in gerekli minimal env variables
          MONGODB_URI: mongodb://localhost:27017/test
          NEXTAUTH_SECRET: test-secret-for-ci
          NEXTAUTH_URL: http://localhost:3000

  # ============================================
  # JOB 3: TYPE CHECK
  # TypeScript type kontrolÃ¼
  # ============================================
  type-check:
    name: ğŸ“ TypeScript Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # TypeScript compilation check (build olmadan)
      - name: ğŸ“ Check TypeScript types
        run: npx tsc --noEmit

  # ============================================
  # JOB 4: LINT
  # ESLint kontrolÃ¼
  # ============================================
  lint:
    name: ğŸ” Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: npm run lint

  # ============================================
  # JOB 5: SECURITY AUDIT
  # npm audit ile gÃ¼venlik kontrolÃ¼
  # ============================================
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”’ Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

# ============================================
# WORKFLOW AÃ‡IKLAMALARI
# ============================================
#
# Bu CI/CD pipeline 5 farklÄ± job Ã§alÄ±ÅŸtÄ±rÄ±r:
#
# 1. TEST (ğŸ§ª):
#    - Jest testlerini Ã§alÄ±ÅŸtÄ±rÄ±r
#    - 24 test baÅŸarÄ±lÄ± olmalÄ±
#    - Coverage raporu oluÅŸturur
#
# 2. BUILD (ğŸ—ï¸):
#    - Production build yapar
#    - Next.js compile kontrolÃ¼
#    - Build hatasÄ± varsa fail olur
#
# 3. TYPE CHECK (ğŸ“):
#    - TypeScript type kontrolÃ¼
#    - tsc --noEmit ile derleme hatasÄ± var mÄ± bakar
#
# 4. LINT (ğŸ”):
#    - ESLint kurallarÄ±nÄ± kontrol eder
#    - Kod standardÄ±na uygun mu?
#
# 5. SECURITY (ğŸ”’):
#    - npm audit ile gÃ¼venlik aÃ§Ä±ÄŸÄ± tarar
#    - Moderate ve Ã¼stÃ¼ aÃ§Ä±klarÄ± bildirir
#
# ============================================
# KULLANIM
# ============================================
#
# Bu dosya .github/workflows/ci.yml konumunda olmalÄ±
#
# Otomatik Ã§alÄ±ÅŸÄ±r:
# - Her push'ta (main/develop branch)
# - Her PR aÃ§Ä±ldÄ±ÄŸÄ±nda
# - PR gÃ¼ncellendiÄŸinde
#
# GitHub'da gÃ¶rÃ¼ntÃ¼leme:
# Repository â†’ Actions sekmesi
#
# ============================================
# STATUS BADGE (README iÃ§in)
# ============================================
#
# README.md'ye ekle:
# ![CI/CD](https://github.com/Aeerszl/Cv-Maker/workflows/CI%2FCD%20Pipeline/badge.svg)
#
